<!--
    Getting iframe size with Window.postMessage()
    @see: https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage
    @see: https://mdn.github.io/dom-examples/channel-messaging-basic/
    @see: https://stackoverflow.com/questions/25098021/securityerror-blocked-a-frame-with-origin-from-accessing-a-cross-origin-frame
-->

<!-- iframe.html -->

<script>
    (function( w, d ) {
        w.onload = function () {
            //Don't run unless in an iframe
            if (self == parent) {
                return;
            }

            const origin_target = '*'; // Any origin
            // const origin_target = 'https://bitsmodo.com'; // Specific origin
            var last_height = 0;

            setInterval( function () {
                    // let height = document.body.scrollHeight;

                    // Calculate semi-actual size with margins and padding
                    // To get full space, you need to set iframe body { position: absolute; }
                    let element = d.body,
                        height = element.getBoundingClientRect().height,
                        style = w.getComputedStyle( element );

                    height = ["top", "bottom"]
                        .map( function ( side ) {
                            return parseInt( style['margin-' + side], 10 );
                        })
                        .reduce( function( total, side ) {
                                return total + side;
                            },
                            height
                        );
                    
                    // Skip no changes
                    if ( height == last_height ) {
                        return;
                    }

                    last_height = height;

                    // Send message to the parent on intervals
                    // to adjust height dynamically
                    parent.postMessage(
                        {
                            event_id: 'document_size',
                            size: {
                                height: height,
                            }
                        },
                        origin_target
                    );
                },
                200
            );            
        };
    })( window, document );
</script>

<!-- parent.html -->

<script>
    (function( w, d ) {
        function get_message( e ) {
            const iframe = d.getElementById("outlet");
            const origin_allowed = '*'; // Any origin
            // const origin_allowed = 'https://bitsmodo.pl, https://bitsmodo.com'; // Specific origin(s)

            if ( origin_allowed !== '*' && ! origin_allowed.includes( e.origin ) ) {
                return false;
            }

            if ( iframe && 'document_size' === e.data.event_id ) {
                iframe.style.height = e.data.size.height + 'px';
            }
        }
        
        w.addEventListener( 'message', get_message );
    })( window, document );
</script>