<!--
    Getting iframe size with Window.postMessage()
    @see: https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage
    @see: https://mdn.github.io/dom-examples/channel-messaging-basic/
    @see: https://stackoverflow.com/questions/25098021/securityerror-blocked-a-frame-with-origin-from-accessing-a-cross-origin-frame
-->

<!-- iframe.html -->

<script>
    (function( w, d ) {
        w.onload = function () {
            //Don't run unless in an iframe
            if (self == parent) {
                return;
            }

            /**
             * Calculate element semi-actual height with margins and padding.
             * To get full space, you need to set also iframe body { position: absolute; }
             * 
             * @param {Element} e DOM Element 
             * @returns string|bool Height as a string like 100px or false on empty element.
             */
            function elementHeight( e ) {
                if ( ! e ) {
                    return false;
                }
                
                let height = e.getBoundingClientRect().height,
                    style = w.getComputedStyle( e );

                height = ["top", "bottom"]
                    .map( function ( side ) {
                        return parseInt( style['margin-' + side], 10 );
                    })
                    .reduce( function( total, side ) {
                            return total + side;
                        },
                        height
                    );

                return height;
            }

            /**
             * Send Window.postMessage with current body height.
             * 
             * @param {string} height Height with unit like 100px
             * @returns void
             */
            function sendBodyHeight( height ) {
                const origin_target = '*'; // Any origin
                // const origin_target = 'https://bitsmodo.com'; // Specific origin
                            
                parent.postMessage(
                    {
                        event_id: 'document_size',
                        size: {
                            height: height,
                        }
                    },
                    origin_target
                );
            };

            /**
             * Monitor size changes.
             */

            // Pre 2020 browsers,
            // when there is no ResizeObserver API (old solution before 2020, far less effective)
            let lastHeight = 0;
            setInterval( () => {
                let height = elementHeight( d.body );

                // Skip no changes
                if ( height != lastHeight ) {
                    lastHeight = height;
                    sendBodyHeight( height );
                }
            }, 200 );

            // Post 2020 browsers,
            // with ResizeObserver API (recommended)
            /*
            const bodySizeObserver = new ResizeObserver( entries => {
                for (const entry of entries) {
                    // Each entry is an instance of ResizeObserverEntry
                    if ( d.body == entry.target ) {
                        // let height = document.body.scrollHeight;
                        let height = elementHeight( d.body );
                        sendBodyHeight( height );
                    }
                }
            }).observe( d.body );
            */
        };
    })( window, document );
</script>

<!-- parent.html -->

<script>
    (function( w, d ) {
        function get_message( e ) {
            const iframe = d.getElementById("outlet");
            const origin_allowed = '*'; // Any origin
            // const origin_allowed = 'https://bitsmodo.pl, https://bitsmodo.com'; // Specific origin(s)

            if ( origin_allowed !== '*' && ! origin_allowed.includes( e.origin ) ) {
                return false;
            }

            if ( iframe && 'document_size' === e.data.event_id ) {
                iframe.style.height = e.data.size.height + 'px';
            }
        }
        
        w.addEventListener( 'message', get_message );
    })( window, document );
</script>