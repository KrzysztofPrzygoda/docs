<!DOCTYPE html>
<html lang="pl" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <title>Czytnik QR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script type="module">
        import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

        window.decodeMultipleFromImage = async (imageElement) => {
            const reader = new BrowserMultiFormatReader();
            try {
                const results = await reader.decodeFromImageElement(imageElement);
                return Array.isArray(results) ? results : [results];
            } catch {
                return [];
            }
        };
    </script>
    <style>
        :root {
            --border-radius: .5rem
        }

        #drop-area {
            border: 2px dashed #6c757d;
            border-radius: var(--border-radius);
            display: grid;
            justify-content: center;
            padding: 1rem;
            text-align: center;
            color: #6c757d;
            cursor: pointer;
        }

        #drop-area.dragover {
            background-color: #f8f9fa;
        }

        #drop-area .info {
            aspect-ratio: 4 / 4;
            display: grid;
            align-content: center;
        }

        #drop-area.dropped .info,
        #drop-area canvas:not([hidden]) ~ .info {
            display: none;
        }

        canvas,
        video {
            border-radius: var(--border-radius);
            border: 1px solid #ced4da;
            width: 100%;
        }

        #camera-canvas,
        #video {
            aspect-ratio: 4 / 3;
            object-fit: cover;
        }

        .camera-wrapper {
            display: inline-block;
            width: 100%;
            max-width: 640px;
        }

        #camera-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            pointer-events: none;
        }

        .history-wrapper {
            display: none;
        }

        .history-wrapper.visible {
            display: block;
        }

        .history-item a {
            word-break: break-all;
        }

        .reader {
            position: sticky;
            top: 1rem;
        }
    </style>
</head>

<body>
    <div class="container mt-5 mb-5">
        <h1 class="mb-5">Czytnik QR</h1>

        <div class="row align-items-start">
            <div class="reader col-md-6">
                <ul class="nav nav-tabs" id="qrTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload"
                            type="button" role="tab">Obraz</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera"
                            type="button" role="tab">Kamera</button>
                    </li>
                </ul>

                <div class="tab-content pt-3">
                    <!-- Obraz -->
                    <div class="tab-pane fade show active" id="upload" role="tabpanel">
                        <div id="drop-area" class="mb-3">
                            <input type="file" id="fileElem" accept="image/*" hidden>
                            <canvas id="upload-canvas" hidden></canvas>
                            <div class="info"><span>UpuÅ›Ä‡ obraz tutaj lub kliknij, aby wybraÄ‡ plik</span></div>
                        </div>
                        <p><span id="upload-result">&nbsp;</span></p>
                    </div>

                    <!-- Kamera -->
                    <div class="tab-pane fade" id="camera" role="tabpanel">
                        <div class="camera-wrapper position-relative">
                            <video id="video" autoplay muted playsinline></video>
                            <canvas id="camera-canvas"></canvas>
                        </div>
                        <p class="mt-3"><span id="camera-result">Uruchamianie kamery...</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="history-wrapper">
                    <!-- <hr class="mt-5"> -->
                    <h4>Odczytane kody</h4>
                    <ul id="history" class="list-group list-group-numbered">
                        <!-- <li class="list-group-item history-item">Czekam na kod...</li> -->
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        const historyEl = document.getElementById("history");

        function addToHistory(text) {
            const li = document.createElement("li");
            li.className = "list-group-item history-item";
            const link = document.createElement("a");
            link.href = text;
            link.textContent = text;
            link.target = "_blank";

            if (!/^https?:\/\//.test(text)) {
                link.href = "#";
                link.removeAttribute("target");
                link.onclick = (e) => e.preventDefault();
            }

            li.appendChild(link);
            historyEl.append(li);
            document.querySelector('.history-wrapper')?.classList.add('visible');
        }

        // === Kamera ===
        const video = document.getElementById("video");
        const camCanvas = document.getElementById("camera-canvas");
        const camCtx = camCanvas.getContext("2d", { willReadFrequently: true });
        const camResult = document.getElementById("camera-result");

        let animationFrameId = null;
        let lastCode = null;
        let stream = null;
        let scanning = false;

        async function startCamera() {
            if (!stream && !scanning) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = stream;
                    video.play();
                    scanning = true;
                    scanCamera();
                    console.log("ðŸ“· Kamera uruchomiona");
                } catch (err) {
                    camResult.textContent = "BÅ‚Ä…d kamery: " + err;
                }
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.srcObject = null;
            scanning = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            console.log("ðŸ›‘ Kamera zatrzymana");
        }

        function drawQRBox(ctx, location, color = '#ff0000') {
            ctx.save();

            // WypeÅ‚nienie
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.2;
            ctx.beginPath();
            ctx.moveTo(location.topLeftCorner.x, location.topLeftCorner.y);
            ctx.lineTo(location.topRightCorner.x, location.topRightCorner.y);
            ctx.lineTo(location.bottomRightCorner.x, location.bottomRightCorner.y);
            ctx.lineTo(location.bottomLeftCorner.x, location.bottomLeftCorner.y);
            ctx.closePath();
            ctx.fill();

            // Obramowanie
            ctx.globalAlpha = 1.0;
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.restore();
        }

        function scanCamera() {
            if (!scanning) return;
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                camCanvas.width = video.videoWidth;
                camCanvas.height = video.videoHeight;
                camCtx.clearRect(0, 0, camCanvas.width, camCanvas.height);
                camCtx.drawImage(video, 0, 0, camCanvas.width, camCanvas.height);
                // Pobierz dane obrazu i przetwÃ³rz kod QR
                const imageData = camCtx.getImageData(0, 0, camCanvas.width, camCanvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) {
                    camResult.textContent = code.data;
                    drawQRBox(camCtx, code.location);

                    if (code.data && code.data !== lastCode) {
                        lastCode = code.data;
                        addToHistory(code.data);
                    }
                    // console.log("Znaleziono kod QR:", code.data);
                } else {
                    camResult.textContent = "Skanowanie...";
                }
            }
            // setTimeout(scanCamera, 500); // spowolnienie do 0.5s
            animationFrameId = requestAnimationFrame(scanCamera);
        }

        // WÅ‚Ä…cz kamerÄ™ przy aktywacji zakÅ‚adki
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', event => {
                const target = event.target.getAttribute('data-bs-target');
                if (target === "#camera") {
                    startCamera();
                } else {
                    stopCamera();
                }
            });
        });

        // WyÅ‚Ä…cz kamerÄ™, gdy uÅ¼ytkownik przejdzie do innej karty
        document.addEventListener("visibilitychange", () => {
            const activeTab = document.querySelector('.nav-link.active')?.getAttribute('data-bs-target');
            if (document.hidden || activeTab !== "#camera") {
                stopCamera();
            } else if (activeTab === "#camera") {
                startCamera();
            }
        });
        window.addEventListener("beforeunload", stopCamera);

        // Automatycznie uruchom kamerÄ™ tylko jeÅ›li zakÅ‚adka Kamera jest domyÅ›lnie aktywna
        if (document.querySelector('.nav-link.active')?.getAttribute('data-bs-target') === '#camera') {
            startCamera();
        }

        // === Obraz ===
        const dropArea = document.getElementById("drop-area");
        const fileElem = document.getElementById("fileElem");
        const uploadCanvas = document.getElementById("upload-canvas");
        const uploadCtx = uploadCanvas.getContext("2d", { willReadFrequently: true });
        const uploadResult = document.getElementById("upload-result");

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.onload = async () => {
                    uploadCanvas.hidden = false;
                    uploadCanvas.width = img.width;
                    uploadCanvas.height = img.height;
                    uploadCtx.drawImage(img, 0, 0);
                    const results = await window.decodeMultipleFromImage(img);
                    uploadResult.textContent = results.length
                        // ? `Znalezione kody: ${results.length}`
                        ? `${results.filter(r => r.text).map(r => r.text).join('<br> ')}`
                        : "Nie znaleziono kodÃ³w QR";

                    results.forEach(result => {
                        if (result.text) {
                            addToHistory(result.text);
                            lastCode = result.text; // Aktualizuj ostatni kod kamery
                        }
                        if (result.resultPoints) {
                            uploadCtx.beginPath();
                            uploadCtx.strokeStyle = '#ff0000ff'; // Czerwony z alfa 0.5
                            uploadCtx.lineWidth = 4;
                            result.resultPoints.forEach((p, i) => {
                                if (i === 0) uploadCtx.moveTo(p.x, p.y);
                                else uploadCtx.lineTo(p.x, p.y);
                            });
                            uploadCtx.closePath();
                            uploadCtx.stroke();
                        }
                    });
                };
                img.src = reader.result;
            };
            reader.readAsDataURL(file);
        }

        dropArea.addEventListener("click", () => fileElem.click());
        fileElem.addEventListener("change", (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });
        dropArea.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropArea.classList.add("dragover");
        });
        dropArea.addEventListener("dragleave", () => {
            dropArea.classList.remove("dragover");
        });
        dropArea.addEventListener("drop", (e) => {
            e.preventDefault();
            dropArea.classList.remove("dragover");
            if (e.dataTransfer.files.length) {
                dropArea.classList.add("dropped");
                handleFile(e.dataTransfer.files[0]);
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>